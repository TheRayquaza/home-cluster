---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install WireGuard
  package:
    name: wireguard
    state: present

- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Enable IPv6 forwarding (optional)
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes

- name: Create WireGuard config directory
  file:
    path: /etc/wireguard
    state: directory
    mode: '0700'

- name: Wireguard Server setup
  block:

  - name: Generate WireGuard server configuration
    template:
      src: wg.conf.j2
      dest: "/etc/wireguard/{{ wg_interface }}.conf"
      mode: '0600'
    notify: restart wireguard

  - name: Enable and start WireGuard service
    systemd:
      name: "wg-quick@{{ wg_interface }}"
      enabled: yes
      state: started

  - name: Gather facts to detect network interfaces
    ansible.builtin.setup:
      gather_subset:
        - network

  - name: Allow WireGuard UDP port
    ansible.builtin.iptables:
      chain: INPUT
      protocol: udp
      destination_port: "{{ wg_port | string }}"
      jump: ACCEPT
      action: insert
      comment: "WireGuard incoming traffic"

  - name: Allow forwarding from VPN subnet
    ansible.builtin.iptables:
      chain: FORWARD
      source: "{{ wg_private_subnet }}"
      jump: ACCEPT
      action: insert
      comment: "Allow WireGuard subnet forwarding"

  - name: Enable NAT (MASQUERADE) for VPN clients
    ansible.builtin.iptables:
      table: nat
      chain: POSTROUTING
      source: "{{ wg_private_subnet }}"
      out_interface: "{{ ansible_default_ipv4.interface }}"
      jump: MASQUERADE
      comment: "NAT for WireGuard clients"

  - name: Install iptables-persistent package
    apt:
      name: iptables-persistent
      state: present
    when: ansible_os_family == "Debian"

  - name: Persist iptables rules
    ansible.builtin.shell: |
      netfilter-persistent save
    changed_when: false
    ignore_errors: true

  - name: Setup directory for static WireGuard client configs
    delegate_to: localhost
    become: false
    run_once: true
    vars:
      ansible_connection: local
    file:
      path: "./static/wg"
      state: directory
      mode: '0700'

  - name: Render all WireGuard client configurations locally
    delegate_to: localhost
    become: false
    run_once: true
    vars:
      ansible_connection: local
    template:
      src: wg-client.conf.j2
      dest: "./static/wg/{{ client.name }}.conf"
      mode: '0600'
    loop: "{{ wg_clients }}"
    loop_control:
      loop_var: client
    when: wg_clients is defined
  when: groups['master'][0] == inventory_hostname

- name: Wireguard Client setup
  block:
  - name: Copy WireGuard client configuration
    copy:
      src: "./static/wg/{{ wg_client_name }}.conf"
      dest: "/etc/wireguard/{{ wg_interface }}.conf"
      mode: '0600'
    notify: restart wireguard

  - name: Enable and start WireGuard service
    systemd:
      name: "wg-quick@{{ wg_interface }}"
      enabled: yes
      state: started
  when: wg_client_name is defined and inventory_hostname not in groups['master']
