- name: Disable swap
  command: sudo swapoff -a
  changed_when: false

- name: Comment out swap in /etc/fstab
  command: sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  changed_when: false

- name: Add the br_netfilter and overlay modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ ['br_netfilter', 'overlay'] }}"
  become: yes
  when: ansible_os_family == "Debian"

- name: Apply sysctl settings
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }
  become: yes
  when: ansible_os_family == "Debian"
  notify: Reload sysctl
